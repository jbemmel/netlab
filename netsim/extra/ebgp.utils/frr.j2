router bgp {{ bgp.as }}
!
! Password, not applied to bgp unnumbered peers
!
{% for n in bgp.neighbors|default([]) if n.password is defined %}
{%   for af in ['ipv4','ipv6'] if n[af] is defined %}
 neighbor {{ n[af] }} password {{ n.password }}
{%   endfor %}
{% endfor %}
!
! Global address families
{% for af in ['ipv4','ipv6'] if af in bgp and bgp[af] %}
 address-family {{ af }}
{%   for n in bgp.neighbors|default([]) if n[af] is defined and n[af] %}
{%     set peer = n[af] if n[af] is string else n.local_if|default('?') %}
{%     if n.allowas_in is defined %}
  neighbor {{ peer }} allowas-in {{ 'origin' if n.allowas_in=="origin" else n.allowas_in|int }}
{%     endif %}
{%     if n.as_override|default(False) %}
  neighbor {{ peer }} as-override
{%     endif %}
{%     if n.default_originate|default(False) %}
  neighbor {{ peer }} default-originate
{%     endif %}
{%   endfor %}
{% endfor %}

{% if vrfs is defined %}
{%   for vname,vdata in vrfs.items() if vdata.bgp|default(False) and vdata.bgp.neighbors|default([]) %}
{%     for af in ['ipv4','ipv6'] if af in vdata.af|default({}) %}
{%       for n in vdata.bgp.neighbors if n[af] is defined and n[af] %}
{%         set peer = n[af] if n[af] is string else n.local_if|default('?') %}
{%         if loop.first %}
 address-family {{ af }} vrf {{ vname }}
{%         endif %}
{%         if n.password is defined %}
  neighbor {{ peer }} password {{ n.password }}
{%         endif %}
{%         if n.allowas_in is defined %}
  neighbor {{ peer }} allowas-in {{ n.allowas_in }}
{%         endif %}
{%         if n.as_override is defined %}
  neighbor {{ peer }} as-override
{%         endif %}
{%         if n.default_originate is defined %}
  neighbor {{ peer }} default-originate
{%         endif %}
{%       endfor %}
{%     endfor %}
{%   endfor %}
{% endif %}
