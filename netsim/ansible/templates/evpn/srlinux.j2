{#
 Enables the EVPN address family for eBGP or iBGP peers (ipv4 for now)

 Assumes bgp.as == AS used for EVPN
#}

updates:
{% for type in evpn.session %}
- path: network-instance[name=default]/protocols/bgp
  val:
{% if type=='ebgp' %}
   export-policy: "accept_all"
{% endif %}
   group:
   - group-name: {{ 'ibgp-ipv4' if type=='ibgp' else 'ebgp' }} # Could create a dedicated group for EVPN only?
     afi-safi:
     - afi-safi-name: evpn
       admin-state: enable
{%  if bgp.rr|default(0) %}
     next-hop-self: False
{%  endif %}
   route-advertisement:
    rapid-withdrawal: True
   afi-safi:
   - afi-safi-name: evpn
     evpn:
      rapid-update: True
{% endfor %}

{# Enable IP advertisement for all irb interfaces in EVPN vlans #}
{% if vrfs is defined and vrfs %}
{% for i in interfaces if i.vrf is defined and vrfs[i.vrf].evpn is defined and i.type=='svi' and i.vlan.mode|default('irb')=='irb' %}
{%  set vrf = vrfs[i.vrf] %}
{%  set symmetric_irb = 'transit_vni' in vrf.evpn %}
- path: /interface[name=irb0]/subinterface[index={{ i.ifname.split('.')[1] }}]
  val:
{%  for ip,arpnd in [('ipv4','arp'),('ipv6','neighbor-discovery')] %}
{%   if ip in i %}
   {{ ip }}:
     {{ arpnd }}:
       learn-unsolicited: {{ True if ip=='ipv4' else 'both' }}
       evpn:
        advertise: # Type of ARP/ND entries to be advertised
        - route-type: dynamic
          _annotate: "Advertise dynamically learned IPs"
        - route-type: static
          _annotate: "Advertise local irb interface IPs"
{%    if symmetric_irb %}
       host-route:
        _annotate: "Create host routes of type 'arp-nd' in ip-vrf route table"
        populate:
        - route-type: dynamic
        # - route-type: static
        # - route-type: evpn # not for entries learned through EVPN
{%    endif %}
{%   endif %}

{%  endfor %}
{% endfor %}
{% endif %}

{# Workaround for EBGP designs #}
{% if 'ebgp' in evpn.session %}
{% set EBGP_COMMUNITY = "target:" + bgp.as | string + ":0" %}
- path: routing-policy/community-set[name=EBGP_ANY_AS_ANY_VNI]
  val:
   _annotate: "Matches any AS and VNI; this works because each mac-vrf only accepts routes with matching vni"
   member:
   - "target:(.*)&(.*)$"

- path: routing-policy/community-set[name=EBGP_COMMUNITY]
  val:
   _annotate: "Internal extended community used to mark/import all EBGP EVPN routes"
   member:
   - "{{ EBGP_COMMUNITY }}"

- path: routing-policy/policy[name=default_ebgp_import]
  val:
   default-action:
    policy-result: accept
   statement:
   - name: "EBGP_MATCH_ANY_AS"
     match:
      family: [ "evpn" ]
      bgp:
       community-set: "EBGP_ANY_AS_ANY_VNI"
     action:
      policy-result: accept
      bgp:
       communities:
        add: "EBGP_COMMUNITY"

- path: network-instance[name=default]/protocols/bgp
  val:
   import-policy: "default_ebgp_import"

{% endif %}
